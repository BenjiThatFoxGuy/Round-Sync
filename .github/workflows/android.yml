name: Android CI Signed

on:
  workflow_dispatch: # Mantiene solo l'esecuzione manuale

jobs:
  build-signed:
    runs-on: ubuntu-latest
    
    # PROMOZIONE DEI SECRETS ALL'AMBIENTE DEL JOB (FIX ERRORE)
    # Questo rende i segreti disponibili e stabili nel contesto 'env'
    env:
      APP_KEYSTORE_BASE64: ${{ secrets.APP_KEYSTORE_BASE64 }}
      KEY_STORE_PASSWORD: ${{ secrets.KEY_STORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
    - name: Checkout sources
      uses: actions/checkout@v4

    - name: Read Versions from properties
      id: config
      run: |
        # Estrae versioni pulendo eventuali spazi bianchi
        GO_VER=$(grep -E "^de\.felixnuesse\.extract\.goVersion=" gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
        NDK_VER=$(grep -E "^de\.felixnuesse\.extract\.ndkVersion=" gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
        
        if [ -z "$GO_VER" ]; then GO_VER="1.23.0"; fi
        
        echo "GO_VERSION=$GO_VER" >> $GITHUB_ENV
        echo "NDK_VERSION=$NDK_VER" >> $GITHUB_ENV
        echo "Detected -> Go: $GO_VER, NDK: $NDK_VER"

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Install NDK
      run: |
        echo "y" | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;${{ env.NDK_VERSION }}"

    # --- DECODIFICA KEYSTORE ---
    - name: Decode Keystore
      # FIX: Controlliamo il secret attraverso il contesto 'env' del job, che è stabile
      if: ${{ env.APP_KEYSTORE_BASE64 }} 
      run: |
        # Usiamo la variabile d'ambiente $APP_KEYSTORE_BASE64 che è stata definita all'inizio del job
        echo "$APP_KEYSTORE_BASE64" | base64 --decode > app/release.keystore

    # --- BUILD ---
    - name: Build Signed Release APK
      env:
        # Passiamo le variabili d'ambiente (che contengono i secrets) a Gradle
        CMD_RELEASE_KEYSTORE: app/release.keystore
        CMD_RELEASE_KEYSTORE_PASSWORD: ${{ env.KEY_STORE_PASSWORD }}
        CMD_RELEASE_KEY_ALIAS: ${{ env.KEY_ALIAS }}
        CMD_RELEASE_KEY_PASSWORD: ${{ env.KEY_PASSWORD }}
      run: |
        ./gradlew assembleOssRelease --stacktrace

    # --- UPLOAD ARTIFACTS (Tutte le architetture) ---
    # Nota: L'upload è per la release build (oss/release)

    - name: Upload APK (Universal)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-universal
        path: app/build/outputs/apk/oss/release/*-oss-universal-release.apk
        if-no-files-found: warn

    - name: Upload APK (Arm64)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-arm64
        path: app/build/outputs/apk/oss/release/*-oss-arm64-v8a-release.apk
        if-no-files-found: warn

    - name: Upload APK (Armv7)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-armeabi
        path: app/build/outputs/apk/oss/release/*-oss-armeabi-v7a-release.apk
        if-no-files-found: warn

    - name: Upload APK (x86)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-x86
        path: app/build/outputs/apk/oss/release/*-oss-x86-release.apk
        if-no-files-found: warn

    - name: Upload APK (x86_64)
      uses: actions/upload-artifact@v4
      with:
        name: round-sync-x64
        path: app/build/outputs/apk/oss/release/*-oss-x86_64-release.apk
        if-no-files-found: warn
